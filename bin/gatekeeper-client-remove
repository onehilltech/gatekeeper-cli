#!/usr/bin/env node
'use strict';

var program    = require ('commander')
  , winston    = require ('winston')
  , prompt     = require ('prompt')
  , gatekeeper = require ('@onehilltech/gatekeeper')
  , path       = require ('path')
  , async      = require ('async')
  ;

async.waterfall ([
  function (app, callback) {
    // command: create
    program
      .command ('add', 'add a new client to the database')
      .description ('add a new client')
      .action (function () {
        prompt.start ();

        prompt.get (['name', 'email', 'redirect', 'roles'], function (err, result) {
          winston.log ('debug', 'adding a new client to the database');

          var client = new Client ({
            name : result.name,
            email : result.email,
            redirect_uri : result.redirect,
            roles : result.roles.split (',')
          });

          client.save (function (err, client) {
            if (err) return callback (err);

            console.log('client_id: ' + client.id);
            console.log('client_secret: ' + client.secret);

            callback (null);
          });
        });
      });

    // command: remove
    program
      .command ('remove <clientId>')
      .description ('remove client from the database')
      .action (function (clientId) {
        Client.findByIdAndRemove (clientId, callback);
      });

    // command: enable
    program
      .command ('enable <clientId> <state>')
      .description ('enable/disable client access')
      .action (function (clientId, state) {
        state = JSON.parse (state.toLowerCase());

        Client.findByIdAndUpdate (clientId, {enabled: state}, callback);
      });

    program.parse (process.argv);
  }
], function (err) {
  if (err) throw err;
  process.exit (0);
});
